generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum SquadRole {
  DEGEN
  SUGAR_DADDY
  ALPHA_CALLER
  TRADER
  DEV
  VIBE_CODER
  KOL
  WHALE
  RESEARCHER
  COMMUNITY_BUILDER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

enum EthosScoreTier {
  BELOW_1400
  TIER_1400
  TIER_1500
  TIER_1600
  TIER_1700
  TIER_1800
  TIER_1900
  TIER_2000_PLUS
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
  EXPIRED
}

enum Benefit {
  EQUITY
  CASH
  TIPS
  EXPOSURE
  MUTUAL
  FUN
}

enum NotificationType {
  APPLICATION_RECEIVED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  APPLICATION_EXPIRED
  POSITION_DELETED
}

model User {
  id        String     @id @default(cuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // === Privy Authentication ===
  privyId       String    @unique
  privyDid      String?   @unique

  // === Ethos Core Fields (READ-ONLY) ===
  ethosProfileId    Int?      @unique
  ethosUserId       Int?      @unique
  ethosUsername     String?
  ethosDisplayName  String?
  ethosAvatarUrl    String?
  ethosDescription  String?   @db.Text
  ethosScore        Int?                    // Credibility score (0-2000)
  ethosStatus       String?                 // ACTIVE, INACTIVE, etc.

  // === Ethos Social Accounts (READ-ONLY) ===
  ethosXHandle      String?                 // Twitter/X username
  ethosXId          String?                 // Twitter/X numeric ID
  ethosDiscordId    String?
  ethosFarcasterId  String?
  ethosTelegramId   String?

  // === Ethos Wallets (READ-ONLY) ===
  ethosPrimaryWallet String?               // Primary Ethereum address
  ethosWallets       String[]              // All linked wallets

  // === Ethos Stats (READ-ONLY) ===
  ethosXpTotal           Int?
  ethosXpStreakDays      Int?
  ethosInfluenceFactor   Float?
  ethosInfluencePercentile Float?

  // === Ethos Raw Data (READ-ONLY) ===
  ethosRawData      Json?                  // Full API response backup
  ethosUserkeys     String[]               // All userkey identifiers
  ethosLastSyncedAt DateTime?

  // === App-Specific (Editable) ===
  email             String?
  customDisplayName String?                // User can override display name
  preferences       Json?

  // === System ===
  role      UserRole   @default(USER)
  status    UserStatus @default(ACTIVE)

  // === Primary Squad Role (for filtering/display) ===
  primarySquadRole  SquadRole?

  // === Squad Relations ===
  createdSquads    Squad[]       @relation("SquadCreator")
  captainedSquads  Squad[]       @relation("SquadCaptain")
  squadMemberships SquadMember[]
  sentInvites      SquadInvite[] @relation("SentInvites")
  receivedInvites  SquadInvite[] @relation("ReceivedInvites")
  chatMessages     ChatMessage[]

  // === Position Relations ===
  applications     Application[]  @relation("Applications")
  notifications    Notification[]

  @@index([ethosProfileId])
  @@index([ethosPrimaryWallet])
  @@index([ethosXHandle])
}

model Squad {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String
  description String?  @db.Text
  avatarUrl   String?

  minSize     Int      @default(2)
  maxSize     Int      @default(5)  // 2-7
  isFixedSize Boolean  @default(false)
  isActive    Boolean  @default(false)  // True when >= 2 members

  // Relations
  creatorId   String
  creator     User     @relation("SquadCreator", fields: [creatorId], references: [id])
  captainId   String
  captain     User     @relation("SquadCaptain", fields: [captainId], references: [id])

  members       SquadMember[]
  invites       SquadInvite[]
  chatMessages  ChatMessage[]
  openPositions OpenPosition[]

  @@index([creatorId])
  @@index([captainId])
  @@index([isActive])
}

model SquadMember {
  id        String    @id @default(cuid())
  joinedAt  DateTime  @default(now())

  squadId   String
  squad     Squad     @relation(fields: [squadId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      SquadRole

  @@unique([squadId, userId])
  @@index([squadId])
  @@index([userId])
}

model SquadInvite {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  squadId     String
  squad       Squad        @relation(fields: [squadId], references: [id], onDelete: Cascade)
  inviterId   String
  inviter     User         @relation("SentInvites", fields: [inviterId], references: [id], onDelete: Cascade)
  inviteeId   String
  invitee     User         @relation("ReceivedInvites", fields: [inviteeId], references: [id], onDelete: Cascade)

  role        SquadRole    // Proposed role
  status      InviteStatus @default(PENDING)
  message     String?      @db.Text
  expiresAt   DateTime
  respondedAt DateTime?

  @@unique([squadId, inviteeId, status])
  @@index([squadId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([status])
}

model ChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  content   String   @db.Text

  squadId   String
  squad     Squad    @relation(fields: [squadId], references: [id], onDelete: Cascade)

  senderId  String
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  isEdited  Boolean  @default(false)
  isDeleted Boolean  @default(false)

  @@index([squadId, createdAt])
  @@index([senderId])
}

model OpenPosition {
  id                  String         @id @default(cuid())
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  squadId             String
  squad               Squad          @relation(fields: [squadId], references: [id], onDelete: Cascade)

  role                SquadRole
  description         String?        @db.Text
  ethosScoreTier      EthosScoreTier @default(BELOW_1400)
  requiresMutualVouch Boolean        @default(false)
  benefits            Benefit[]      @default([])

  expiresAt           DateTime       // 30 days from creation
  isOpen              Boolean        @default(true)

  applications        Application[]

  @@index([squadId])
  @@index([isOpen, expiresAt])
  @@index([role])
  @@index([benefits])
}

model Application {
  id          String            @id @default(cuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  positionId  String
  position    OpenPosition      @relation(fields: [positionId], references: [id], onDelete: Cascade)

  applicantId String
  applicant   User              @relation("Applications", fields: [applicantId], references: [id], onDelete: Cascade)

  message     String?           @db.Text
  status      ApplicationStatus @default(PENDING)
  expiresAt   DateTime          // 7 days from application
  respondedAt DateTime?

  @@unique([positionId, applicantId])
  @@index([positionId])
  @@index([applicantId])
  @@index([status])
}

model Notification {
  id        String           @id @default(cuid())
  createdAt DateTime         @default(now())

  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String           @db.Text
  read      Boolean          @default(false)

  squadId       String?
  positionId    String?
  applicationId String?

  @@index([userId, read])
  @@index([userId, createdAt])
}
